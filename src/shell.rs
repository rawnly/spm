use crate::config::Shell;
use indoc::indoc;

pub fn generate_hook(shell: Shell, use_zellij: bool) -> String {
    match (shell, use_zellij) {
        (Shell::Zsh, false) => indoc! {r#"
            # Side Project Manager - generated by: spm init zsh
            function sp() {
                local selected=$(spm pick)
                if [[ -n "$selected" ]]; then
                    cd "$selected"
                fi
            }
        "#}.to_string(),

        (Shell::Zsh, true) => indoc! {r#"
            # Side Project Manager - generated by: spm init zsh
            function sp() {
                local selected=$(spm pick)
                if [[ -n "$selected" ]]; then
                    local session_name=$(basename "$selected")
                    # Check if session exists and is alive (not EXITED)
                    local session_alive=$(zellij list-sessions 2>/dev/null | grep "^$session_name" | grep -v EXITED)
                    local session_dead=$(zellij list-sessions 2>/dev/null | grep "^$session_name" | grep EXITED)

                    # Clean up dead sessions
                    if [[ -n "$session_dead" ]]; then
                        zellij delete-session "$session_name" 2>/dev/null
                    fi

                    if [[ -n "$ZELLIJ" ]]; then
                        # Already in zellij, avoid nesting
                        if [[ -z "$session_alive" ]]; then
                            zellij -s "$session_name" options --default-cwd "$selected" &
                            disown
                            sleep 0.3
                        fi
                        zellij action switch-session "$session_name"
                    else
                        if [[ -n "$session_alive" ]]; then
                            zellij attach "$session_name"
                        else
                            zellij -s "$session_name" options --default-cwd "$selected"
                        fi
                    fi
                fi
            }
        "#}.to_string(),

        (Shell::Bash, false) => indoc! {r#"
            # Side Project Manager - generated by: spm init bash
            function sp() {
                local selected=$(spm pick)
                if [[ -n "$selected" ]]; then
                    cd "$selected"
                fi
            }
        "#}.to_string(),

        (Shell::Bash, true) => indoc! {r#"
            # Side Project Manager - generated by: spm init bash
            function sp() {
                local selected=$(spm pick)
                if [[ -n "$selected" ]]; then
                    local session_name=$(basename "$selected")
                    # Check if session exists and is alive (not EXITED)
                    local session_alive=$(zellij list-sessions 2>/dev/null | grep "^$session_name" | grep -v EXITED)
                    local session_dead=$(zellij list-sessions 2>/dev/null | grep "^$session_name" | grep EXITED)

                    # Clean up dead sessions
                    if [[ -n "$session_dead" ]]; then
                        zellij delete-session "$session_name" 2>/dev/null
                    fi

                    if [[ -n "$ZELLIJ" ]]; then
                        # Already in zellij, avoid nesting
                        if [[ -z "$session_alive" ]]; then
                            zellij -s "$session_name" options --default-cwd "$selected" &
                            disown
                            sleep 0.3
                        fi
                        zellij action switch-session "$session_name"
                    else
                        if [[ -n "$session_alive" ]]; then
                            zellij attach "$session_name"
                        else
                            zellij -s "$session_name" options --default-cwd "$selected"
                        fi
                    fi
                fi
            }
        "#}.to_string(),

        (Shell::Fish, false) => indoc! {r#"
            # Side Project Manager - generated by: spm init fish
            function sp
                set selected (spm pick)
                if test -n "$selected"
                    cd "$selected"
                end
            end
        "#}.to_string(),

        (Shell::Fish, true) => indoc! {r#"
            # Side Project Manager - generated by: spm init fish
            function sp
                set selected (spm pick)
                if test -n "$selected"
                    set session_name (basename "$selected")
                    # Check if session exists and is alive (not EXITED)
                    set session_alive (zellij list-sessions 2>/dev/null | grep "^$session_name" | grep -v EXITED)
                    set session_dead (zellij list-sessions 2>/dev/null | grep "^$session_name" | grep EXITED)

                    # Clean up dead sessions
                    if test -n "$session_dead"
                        zellij delete-session "$session_name" 2>/dev/null
                    end

                    if test -n "$ZELLIJ"
                        # Already in zellij, avoid nesting
                        if test -z "$session_alive"
                            zellij -s "$session_name" options --default-cwd "$selected" &
                            disown
                            sleep 0.3
                        end
                        zellij action switch-session "$session_name"
                    else
                        if test -n "$session_alive"
                            zellij attach "$session_name"
                        else
                            zellij -s "$session_name" options --default-cwd "$selected"
                        end
                    end
                end
            end
        "#}.to_string(),
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_zsh_hook_no_zellij() {
        let hook = generate_hook(Shell::Zsh, false);
        assert!(hook.contains("function sp()"));
        assert!(hook.contains("cd \"$selected\""));
        assert!(!hook.contains("zellij"));
    }

    #[test]
    fn test_zsh_hook_with_zellij() {
        let hook = generate_hook(Shell::Zsh, true);
        assert!(hook.contains("function sp()"));
        assert!(hook.contains("zellij"));
        assert!(hook.contains("zellij attach"));
        assert!(hook.contains("zellij action switch-session"));
        assert!(hook.contains("$ZELLIJ"));
        assert!(hook.contains("delete-session"));
        assert!(!hook.contains("cd \"$selected\""));
    }

    #[test]
    fn test_bash_hook_no_zellij() {
        let hook = generate_hook(Shell::Bash, false);
        assert!(hook.contains("function sp()"));
        assert!(hook.contains("spm init bash"));
    }

    #[test]
    fn test_fish_hook_no_zellij() {
        let hook = generate_hook(Shell::Fish, false);
        assert!(hook.contains("function sp"));
        assert!(hook.contains("set selected"));
        assert!(hook.contains("cd \"$selected\""));
    }

    #[test]
    fn test_fish_hook_with_zellij() {
        let hook = generate_hook(Shell::Fish, true);
        assert!(hook.contains("function sp"));
        assert!(hook.contains("zellij"));
        assert!(hook.contains("set session_name"));
        assert!(hook.contains("zellij action switch-session"));
        assert!(hook.contains("$ZELLIJ"));
        assert!(hook.contains("delete-session"));
    }
}
